<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Planner">
    <link rel="apple-touch-icon" href="https://img.icons8.com/fluency/180/agenda.png">
    <title>Premium Vertical Planner - Cloud Sync</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=LINE+Seed+JP:wght@400;700;800&family=Shippori+Mincho:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/weather-icons/2.0.12/css/weather-icons.min.css">
    <style>
        :root {
            --cover-color: #1a202c;
            --paper-bg: #fdfaf5;
            --line-color: #e2d9c8;
            --text-main: #2d3748;
            --accent-gold: #b69b5c;
            --accent-soft: #718096;
            --holiday-red: #a52a2a;
            --saturday-blue: #4a6791;
            --anniversary-color: #d69e2e;
        }

        body {
            font-family: 'LINE Seed JP', sans-serif;
            background-color: var(--body-bg, #2c3e50);
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            margin: 0;
            padding: env(safe-area-inset-top) 10px 20px 10px;
            color: var(--text-main);
            overflow-x: hidden;
            transition: all 0.5s ease;
            -webkit-tap-highlight-color: transparent;
        }

        .notebook-container { width: 100%; max-width: 520px; }

        .notebook {
            background-color: var(--paper-bg); border-radius: 12px;
            box-shadow: 0 0 0 8px var(--cover-color), 0 20px 50px rgba(0,0,0,0.5), inset 0 0 10px rgba(0,0,0,0.05);
            position: relative; min-height: 90vh; display: flex; flex-direction: column;
            border: 1px solid rgba(0,0,0,0.1); overflow: hidden; transition: box-shadow 0.3s ease;
        }

        /* CSS Êó•Êú¨ÂõΩÊóó */
        .jp-flag {
            display: inline-block; width: 18px; height: 12px; background-color: #ffffff;
            border: 0.5px solid #ddd; position: relative; vertical-align: middle;
            margin-left: 6px; box-shadow: 0 1px 1px rgba(0,0,0,0.1);
        }
        .jp-flag::after {
            content: ""; position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%); width: 6px; height: 6px;
            background-color: #bc002d; border-radius: 50%;
        }

        /* „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥„É≠„Éº„ÉÄ„Éº */
        .loader {
            width: 40px; height: 20px;
            --c: no-repeat radial-gradient(farthest-side, var(--accent-gold) 93%, #0000);
            background: var(--c) 0 0, var(--c) 50% 0, var(--c) 100% 0;
            background-size: 8px 8px; position: relative;
            animation: l4-0 1s linear infinite alternate;
        }
        .loader:before {
            content: ""; position: absolute; width: 8px; height: 12px;
            background: var(--accent-gold); left: 0; top: 0;
            animation: l4-1 1s linear infinite alternate, l4-2 0.5s cubic-bezier(0,200,.8,200) infinite;
        }
        @keyframes l4-0 { 0% {background-position: 0 100%, 50% 0, 100% 0} 50% {background-position: 0 0, 50 100%, 100% 0} 100% {background-position: 0 0, 50% 0, 100% 100%} }
        @keyframes l4-1 { 100% {left:calc(100% - 8px)} }
        @keyframes l4-2 { 100% {top:-0.1px} }

        .jp-header {
            font-family: 'Shippori Mincho', serif; border-bottom: 1.5px solid var(--accent-gold);
            margin: 15px 30px 20px 30px; padding-bottom: 8px; font-size: 0.85rem; color: var(--accent-gold);
            display: flex; justify-content: space-between; align-items: baseline; font-weight: 700;
        }


        .tab-btn {
            flex: 1; padding: 14px 0; font-size: 0.65rem; font-weight: 800;
            color: var(--accent-soft); border-bottom: 1px solid var(--line-color);
            background: rgba(0,0,0,0.02);
        }
        .tab-active { color: var(--cover-color); background: transparent; border-bottom: 3px solid var(--cover-color); }

        .view-container { flex-grow: 1; padding-bottom: 40px; }
        .list-row { display: flex; align-items: center; border-bottom: 1px solid var(--line-color); padding: 12px 25px; }
        .day-num { width: 35px; font-weight: 800; font-size: 1.1rem; }
        .day-name { width: 40px; font-size: 0.7rem; font-weight: 800; }
        
        .row-input { flex-grow: 1; background: transparent; border: none; outline: none; font-size: 0.9rem; color: var(--text-main); padding: 2px 0; font-weight: 700; }

        .diary-area {
            font-family: 'Shippori Mincho', serif; line-height: 2.2;
            background-size: 100% 2.2em; background-image: linear-gradient(var(--line-color) 0.5px, transparent 0.5px);
            background-attachment: local; padding: 0 15px; min-height: 90vh; width: 100%;
        }

        .is-sunday, .is-holiday { color: var(--holiday-red) !important; }
        .is-saturday { color: var(--saturday-blue) !important; }
        .is-anniversary { color: var(--anniversary-color) !important; }
        .is-today { background-color: rgba(182, 155, 92, 0.08) !important; border-left: 4px solid var(--accent-gold) !important; }
        
        .daily-date-display { font-family: 'Shippori Mincho', serif; cursor: pointer; letter-spacing: 0.05em; }

        /* Auth UI */
        .auth-card { background: var(--paper-bg); padding: 30px; border-radius: 12px; width: 90%; max-width: 350px; border: 1px solid rgba(0,0,0,0.1); }
        .auth-input { width: 100%; padding: 14px; margin-bottom: 12px; border: 1px solid var(--line-color); border-radius: 8px; outline: none; font-size: 0.95rem; }
        .auth-btn { width: 100%; padding: 14px; background: var(--cover-color); color: #fff; border-radius: 8px; font-weight: 800; }
        
        .google-btn {
            width: 100%; padding: 12px; background: #fff; color: #3c4043; border: 1px solid #dadce0;
            border-radius: 8px; font-weight: 600; display: flex; align-items: center;
            justify-content: center; gap: 12px; margin-top: 15px; font-size: 0.9rem;
            transition: background-color 0.2s;
        }

        .theme-swatch { width: 35px; height: 35px; border-radius: 50%; border: 2px solid #fff; cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .theme-swatch.active { transform: scale(1.2); box-shadow: 0 0 0 2px var(--accent-gold); }

        .header-obj-block { flex-grow: 1; margin-left: 10px; position: relative; }
        .header-obj-input { width: 100%; background: rgba(0,0,0,0.03); border: none; border-left: 2px solid var(--accent-gold); color: var(--text-main); font-size: 0.95rem; font-weight: 700; padding: 6px 8px; outline: none; }
        
        .hidden { display: none !important; }
        #date-picker-hidden { position: absolute; opacity: 0; pointer-events: none; }
        .crest-background { position: absolute; right: 15px; bottom: 70px; pointer-events: none; z-index: 1; opacity: 0.2; }
    </style>
</head>
<body>

    <!-- „É≠„Éº„ÉâÁîªÈù¢ -->
    <div id="loading" class="fixed inset-0 z-[1000] flex flex-col items-center justify-center bg-white text-center">
        <div class="loader"></div>
        <div id="loading-text" class="mt-8 text-accent-gold font-bold tracking-[0.4em] animate-pulse text-[10px]">INITIALIZING...</div>
    </div>

    <div class="sync-status fixed top-2 right-2 text-[8px] opacity-30 z-[100]" id="sync-status">OFFLINE</div>

    <div class="notebook-container mx-auto">
        
        <!-- Ë™çË®ºÁîªÈù¢ -->
        <div id="view-auth" class="hidden h-screen flex items-center justify-center">
            <div class="auth-card text-center">
                <div class="mb-8">
                    <h1 class="font-serif text-xl font-bold tracking-[0.3em] text-cover-color uppercase">Cloud Planner</h1>
                    <div class="h-px w-12 bg-accent-gold mx-auto mt-2"></div>
                </div>
                <input type="email" id="auth-email" class="auth-input" placeholder="Email">
                <input type="password" id="auth-password" class="auth-input" placeholder="Password">
                <button onclick="window.handleAuth()" id="auth-submit-btn" class="auth-btn uppercase">Login</button>
                
                <button onclick="window.handleGoogleAuth()" class="google-btn">
                    <svg width="18" height="18" viewBox="0 0 18 18"><path d="M17.64 9.2c0-.637-.057-1.251-.164-1.84H9v3.481h4.844c-.209 1.125-.843 2.078-1.796 2.717v2.258h2.908c1.702-1.567 2.684-3.874 2.684-6.615z" fill="#4285f4"/><path d="M9 18c2.43 0 4.467-.806 5.956-2.184L12.048 13.56c-.408.273-.93.432-1.548.432-1.191 0-2.199-.806-2.557-1.889H4.912v2.335A8.997 8.997 0 0 0 9 18z" fill="#34a853"/><path d="M6.443 12.103c-.188-.564-.296-1.166-.296-1.79 0-.624.108-1.226.296-1.79V6.188H4.912a8.992 8.992 0 0 0 0 8.251l1.531-2.336z" fill="#fbbc05"/><path d="M9 4.009c1.322 0 2.509.454 3.441 1.345l2.582-2.58C13.463 1.155 11.427 0 9 0A8.997 8.997 0 0 0 4.912 2.335L6.443 4.67c.358-1.083 1.366-1.889 2.557-1.889z" fill="#ea4335"/></svg>
                    Google„Åß„Çµ„Ç§„É≥„Ç§„É≥
                </button>
                <p id="auth-error-msg" class="text-[10px] text-red-500 mt-4 h-4"></p>
                <div onclick="window.toggleAuthMode()" id="auth-switch-text" class="text-[10px] text-accent-soft text-center mt-6 cursor-pointer underline">Êñ∞Ë¶èÁôªÈå≤„ÅØ„Åì„Å°„Çâ</div>
            </div>
        </div>

        <!-- „É°„Ç§„É≥„Ç≥„É≥„ÉÜ„É≥„ÉÑ -->
        <div id="app-area" class="notebook hidden">
            
            <div id="main-nav" class="flex bg-white/60 sticky top-0 z-20 border-b border-gray-100">
                <button onclick="window.switchView('monthly')" class="tab-btn" id="tab-monthly">MONTHLY</button>
                <button onclick="window.switchView('weekly')" class="tab-btn" id="tab-weekly">WEEKLY</button>
                <button onclick="window.switchView('daily')" class="tab-btn" id="tab-daily">DAILY</button>
                <button onclick="window.switchView('settings')" class="tab-btn" id="tab-settings">CONFIG</button>
            </div>

            <div class="page-content" id="page-body">
                <div class="crest-background"><svg width="140" height="140" viewBox="0 0 100 100"><circle cx="50" cy="50" r="40" stroke="currentColor" stroke-width="0.5" fill="none"/></svg></div>
                <div class="jp-header" id="jp-header-text"></div>
                
                <!-- Êó•Âà•„Éì„É•„Éº -->
                <div id="view-daily" class="view-container hidden px-10">
                    <div class="flex justify-between items-end border-b border-gray-300 pb-3 mb-2">
                        <div class="flex items-baseline relative shrink-0">
                            <div id="date-label" class="daily-date-display font-bold text-3xl" onclick="window.openDatePicker()"></div>
                            <input type="date" id="date-picker-hidden">
                        </div>
                        <div class="header-obj-block">
                            <input type="text" id="main-objective-field" class="header-obj-input" placeholder="Main Objective..." oninput="window.debouncedSave()">
                        </div>
                        <div id="daily-holiday-name" class="font-bold text-[9px] text-holiday-red mb-1 shrink-0 ml-1"></div>
                    </div>
                    <div id="daily-almanac" class="flex gap-4 font-serif text-[0.8rem] text-accent-gold font-bold mb-6"></div>
                    <div class="mb-8"><h3 class="text-[8px] font-black text-gray-400 uppercase tracking-widest mb-4">Missions</h3><div id="todo-list"></div><button onclick="window.addTodo()" class="btn-action mt-2">+ NEW TASK</button></div>
                    <div><h3 class="text-[8px] font-black text-gray-400 uppercase tracking-widest mb-4">Reflections</h3><textarea id="note-area" class="diary-area border-none outline-none resize-none overflow-hidden" placeholder="..." oninput="window.autoResize(this); window.debouncedSave()"></textarea></div>
                </div>

                <!-- ÈÄ±Èñì„Éì„É•„Éº -->
                <div id="view-weekly" class="view-container hidden px-8">
                    <div class="flex justify-between items-center mb-6">
                        <button onclick="window.handlePrev()" class="p-2">‚óÄ</button>
                        <h2 id="weekly-title" class="text-xs font-bold tracking-widest text-accent-soft uppercase">Week</h2>
                        <button onclick="window.handleNext()" class="p-2">‚ñ∂</button>
                    </div>
                    <div id="weekly-container" class="space-y-4"></div>
                </div>

                <!-- ÊúàÈñì„Éì„É•„Éº -->
                <div id="view-monthly" class="view-container hidden px-2">
                    <div class="px-8 mb-6 flex justify-between items-center">
                        <button onclick="window.handlePrev()" class="p-2">‚óÄ</button>
                        <h2 id="monthly-title" class="text-lg font-black border-b-2 border-accent-gold pb-1 px-4">Month</h2>
                        <button onclick="window.handleNext()" class="p-2">‚ñ∂</button>
                    </div>
                    <div id="monthly-list-container" class="pb-10"></div>
                </div>

                <!-- Ë®≠ÂÆö„Éì„É•„Éº -->
                <div id="view-settings" class="view-container hidden px-8 pt-5 text-center text-accent-soft">
                    <h3 class="text-[9px] font-black tracking-widest mb-6 uppercase">Color Themes</h3>
                    <div class="grid grid-cols-5 gap-4 mb-10" id="theme-selector">
                        <div class="theme-swatch active" onclick="setTheme('standard')" style="background: #1a202c;"></div><div class="theme-swatch" onclick="setTheme('midnight')" style="background: #1a2639;"></div><div class="theme-swatch" onclick="setTheme('forest')" style="background: #2d4a22;"></div><div class="theme-swatch" onclick="setTheme('sakura')" style="background: #fec5bb;"></div><div class="theme-swatch" onclick="setTheme('akane')" style="background: #7a1a1a;"></div><div class="theme-swatch" onclick="setTheme('sumizome')" style="background: #000000;"></div><div class="theme-swatch" onclick="setTheme('asagi')" style="background: #008b8b;"></div><div class="theme-swatch" onclick="setTheme('yamabuki')" style="background: #d97706;"></div><div class="theme-swatch" onclick="setTheme('kachiiro')" style="background: #0d1b2a;"></div><div class="theme-swatch" onclick="setTheme('uguisu')" style="background: #606c38;"></div>
                    </div>
                    
                    <div class="mb-10">
                        <h3 class="text-[9px] font-black tracking-widest mb-6 uppercase">Anniversaries</h3>
                        <div id="anniversary-list" class="mb-6"></div>
                        <div class="bg-black/5 p-4 rounded flex flex-col gap-3">
                            <div class="flex gap-2">
                                <input type="text" id="anni-label" class="bg-white border-none rounded p-2 text-xs flex-grow" placeholder="‰æãÔºöË™ïÁîüÊó•">
                                <input type="text" id="anni-date" class="bg-white border-none rounded p-2 text-xs w-24" placeholder="MM-DD">
                            </div>
                            <button onclick="window.addAnniversary()" class="bg-accent-gold text-white font-bold py-2 rounded text-[10px] tracking-widest">+ ADD</button>
                        </div>
                    </div>

                    <!-- „ÅäÂïèÂêà„Çè„Åõ„Çª„ÇØ„Ç∑„Éß„É≥ -->
                    <div class="mt-10 pt-6 border-t border-gray-100">
                        <h3 class="text-[9px] font-black tracking-widest mb-4 uppercase">Support / Inquiry</h3>
                        <p class="text-[10px] mb-2 opacity-60">„Åî‰∏çÊòéÁÇπ„ÅØ„Åì„Å°„Çâ„Åæ„ÅßÔºö</p>
                        <a href="mailto:support@example.com" id="support-email-link" class="text-[11px] font-bold text-cover-color underline italic">support@example.com</a>
                    </div>

                    <div class="mt-10">
                        <button onclick="window.handleLogout()" class="text-xs font-bold text-red-400 tracking-widest uppercase italic">Logout</button>
                        <p class="text-[7px] mt-4 uppercase"><span id="user-email-disp">...</span></p>
                    </div>
                </div>
            </div>

            <div class="p-4 bg-black/5 border-t border-gray-100 flex justify-between items-center text-[8px] text-gray-400 tracking-[0.4em] font-black">
                <button onclick="window.handlePrev()">PREV</button>
                <span>SYNCHRONIZED EDITION</span>
                <button onclick="window.handleNext()">NEXT</button>
            </div>
        </div>
    </div>

    <!-- Firebase & Planner Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, onSnapshot, collection } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // =========================================================================
        // „ÄêÈáçË¶Å„ÄëFirebase „Ç≥„É≥„ÇΩ„Éº„É´„Åã„Çâ„Ç≥„Éî„Éº„Åó„ÅüË®≠ÂÆö„Çí„Åì„Åì„Å´Ë≤º„Çä‰ªò„Åë„Å¶„Åè„Å†„Åï„ÅÑ
        // =========================================================================
        const firebaseConfig = {
              apiKey: "AIzaSyB-CKqjGBrl3239d2K0X4C9ceFA0tUhoDs",
  authDomain: "pro-planner-a9405.firebaseapp.com",
  projectId: "pro-planner-a9405",
  storageBucket: "pro-planner-a9405.firebasestorage.app",
  messagingSenderId: "930319488179",
  appId: "1:930319488179:web:dbc0f9f2530fd6fe828cc6",
  measurementId: "G-LTRFWPFH63"
        };
        // =========================================================================

        // „ÅäÂïèÂêà„Çè„ÅõÁî®„ÅÆ„Ç¢„Éâ„É¨„Çπ„Åå„ÅÇ„Çå„Å∞„Åì„Åì„ÇíÊõ∏„ÅçÊèõ„Åà„Å¶„Åè„Å†„Åï„ÅÑÔºàË°®Á§∫Áî®Ôºâ
        const SUPPORT_EMAIL = "shinyasekkeisha@gmail.com"; 

        const state = {
            user: null, view: 'daily', authMode: 'login',
            currentDate: new Date().toISOString().split('T')[0],
            displayMonth: new Date(), displayWeekStart: new Date(),
            allData: {}, holidayPatch: {}, settings: { theme: 'standard', anniversaries: [] }
        };

        const themes = {
            standard: { '--cover-color': '#1a202c', '--accent-gold': '#b69b5c', '--accent-soft': '#718096', '--paper-bg': '#fdfaf5', '--text-main': '#2d3748', '--body-bg': '#2c3e50', '--anniversary-color': '#d69e2e' },
            midnight: { '--cover-color': '#1a2639', '--accent-gold': '#8da9c4', '--accent-soft': '#667b94', '--paper-bg': '#f0f4f8', '--text-main': '#1a2639', '--body-bg': '#0b132b', '--anniversary-color': '#718096' },
            forest: { '--cover-color': '#2d4a22', '--accent-gold': '#a3b18a', '--accent-soft': '#588157', '--paper-bg': '#f0f5ec', '--text-main': '#1b261b', '--body-bg': '#132a13', '--anniversary-color': '#b69b5c' },
            sakura: { '--cover-color': '#f8ad9d', '--accent-gold': '#ffb5a7', '--accent-soft': '#fbc4ab', '--paper-bg': '#fff5f5', '--text-main': '#6d4c41', '--body-bg': '#fec5bb', '--anniversary-color': '#e07a5f' },
            akane: { '--cover-color': '#7a1a1a', '--accent-gold': '#f6ad55', '--accent-soft': '#dd6b20', '--paper-bg': '#fff5f5', '--text-main': '#2d3748', '--body-bg': '#4a1111', '--anniversary-color': '#e53e3e' },
            sumizome: { '--cover-color': '#000000', '--accent-gold': '#718096', '--accent-soft': '#a0aec0', '--paper-bg': '#ffffff', '--text-main': '#000000', '--body-bg': '#1a202c', '--anniversary-color': '#4a5568' },
            asagi: { '--cover-color': '#008b8b', '--accent-gold': '#48cae4', '--accent-soft': '#0096c7', '--paper-bg': '#f8ffff', '--text-main': '#1a202c', '--body-bg': '#005f73', '--anniversary-color': '#0077b6' },
            yamabuki: { '--cover-color': '#d97706', '--accent-gold': '#fbbf24', '--accent-soft': '#b45309', '--paper-bg': '#fffbeb', '--text-main': '#000000', '--body-bg': '#92400e', '--anniversary-color': '#f59e0b' },
            kachiiro: { '--cover-color': '#0d1b2a', '--accent-gold': '#e0e1dd', '--accent-soft': '#778da9', '--paper-bg': '#f4f4f9', '--text-main': '#0d1b2a', '--body-bg': '#1b263b', '--anniversary-color': '#415a77' },
            uguisu: { '--cover-color': '#606c38', '--accent-gold': '#dda15e', '--accent-soft': '#bc6c25', '--paper-bg': '#fefae0', '--text-main': '#283618', '--body-bg': '#283618', '--anniversary-color': '#bc6c25' }
        };

        const dayNames = ['Êó•', 'Êúà', 'ÁÅ´', 'Ê∞¥', 'Êú®', 'Èáë', 'Âúü'];
        const rokuyoNames = ["Â§ßÂÆâ", "ÂÖàÂãù", "ÂèãÂºï", "ÂÖàË≤†", "‰ªèÊªÖ", "Ëµ§Âè£"];
        const appId = "my-planner-pro-v2";
        let db, authInstance;

        const els = {
            loading: document.getElementById('loading'),
            viewAuth: document.getElementById('view-auth'),
            appArea: document.getElementById('app-area'),
            dateLabel: document.getElementById('date-label'),
            datePicker: document.getElementById('date-picker-hidden'),
            jpHeader: document.getElementById('jp-header-text'),
            mainObj: document.getElementById('main-objective-field'),
            note: document.getElementById('note-area'),
            todo: document.getElementById('todo-list'),
            userEmail: document.getElementById('user-email-disp'),
            authEmail: document.getElementById('auth-email'),
            authPass: document.getElementById('auth-password'),
            authBtn: document.getElementById('auth-submit-btn'),
            authSwitch: document.getElementById('auth-switch-text'),
            authError: document.getElementById('auth-error-msg'),
            anniversaryList: document.getElementById('anniversary-list'),
            supportLink: document.getElementById('support-email-link')
        };

        async function start() {
            try {
                const app = initializeApp(firebaseConfig);
                authInstance = getAuth(app);
                db = getFirestore(app);

                // „ÅäÂïèÂêà„Çè„Åõ„É™„É≥„ÇØ„ÅÆË®≠ÂÆö
                if(els.supportLink) {
                    els.supportLink.href = `mailto:${SUPPORT_EMAIL}`;
                    els.supportLink.textContent = SUPPORT_EMAIL;
                }

                const res = await fetch('https://holidays-jp.github.io/api/v1/date.json');
                if (res.ok) state.holidayPatch = await res.json();

                onAuthStateChanged(authInstance, async (user) => {
                    if (user) {
                        state.user = user;
                        els.userEmail.textContent = user.email;
                        els.viewAuth.classList.add('hidden');
                        els.appArea.classList.remove('hidden');
                        
                        const snap = await getDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'settings', 'config'));
                        if (snap.exists()) state.settings = { ...state.settings, ...snap.data() };
                        
                        applyTheme();
                        els.loading.classList.add('hidden');
                        
                        onSnapshot(collection(db, 'artifacts', appId, 'users', user.uid, 'dailyData'), (snap) => {
                            snap.forEach(d => { state.allData[d.id] = d.data(); });
                            refreshUI();
                        });
                    } else {
                        state.user = null;
                        state.allData = {};
                        els.loading.classList.add('hidden');
                        els.viewAuth.classList.remove('hidden');
                        els.appArea.classList.add('hidden');
                    }
                });

                if (els.datePicker) els.datePicker.onchange = (e) => window.goToDate(e.target.value);
            } catch (err) { console.error(err); }
        }

        window.switchView = (v) => {
            state.view = v;
            if (v === 'weekly') {
                const d = parseLocalDate(state.currentDate);
                d.setDate(d.getDate() + ((d.getDay() === 0 ? -6 : 1) - d.getDay()));
                state.displayWeekStart = new Date(d);
            }
            refreshUI();
            window.scrollTo(0,0);
        };

        function refreshUI() {
            if (!state.user) return;

            document.querySelectorAll('.tab-btn').forEach(b => b.classList.toggle('tab-active', b.id === `tab-${state.view}`));
            document.querySelectorAll('.view-container').forEach(v => v.classList.add('hidden'));
            document.getElementById(`view-${state.view}`).classList.remove('hidden');

            const d = parseLocalDate(state.currentDate);
            const isHoliday = !!state.holidayPatch[state.currentDate];
            const mDay = state.currentDate.substring(5);
            const anni = state.settings.anniversaries?.find(a => a.date === mDay);
            const holidayName = state.holidayPatch[state.currentDate] || "";
            const dispHoliday = anni ? (holidayName ? `${holidayName} / ${anni.label}` : anni.label) : holidayName;
            
            els.jpHeader.innerHTML = `<span>${d.getMonth()+1}Êúà</span><span>${d.getFullYear()}Âπ¥</span>`;

            if (state.view === 'daily') {
                const cls = isHoliday ? 'is-holiday' : (anni ? 'is-anniversary' : (d.getDay()===0?'is-sunday':(d.getDay()===6?'is-saturday':'')));
                els.dateLabel.className = `daily-date-display font-bold text-3xl ${cls}`;
                els.dateLabel.innerHTML = `${d.getDate()}Êó• ${isHoliday ? '<span class="jp-flag"></span>' : ''} <span class="text-xl opacity-40 font-normal ml-1">${dayNames[d.getDay()]}</span>`;
                document.getElementById('daily-holiday-name').textContent = dispHoliday;
                
                const lunarBase = new Date(2026, 0, 19); 
                const diff = Math.floor((d - lunarBase) / 86400000);
                document.getElementById('daily-almanac').innerHTML = `<span>${rokuyoNames[Math.abs(diff % 6)]}</span><span class="text-lg opacity-70"><i class="wi wi-moon-alt-waxing-crescent-3"></i></span>`;

                const data = state.allData[state.currentDate] || { mainObjective: "", note: "", todos: [] };
                if (document.activeElement !== els.mainObj) els.mainObj.value = data.mainObjective || "";
                if (document.activeElement !== els.note) els.note.value = data.note || "";
                renderTodos(data.todos || []);
                window.autoResize(els.note);
            } else if (state.view === 'weekly') renderWeekly();
            else if (state.view === 'monthly') renderMonthly();
        }

        function renderWeekly() {
            const start = new Date(state.displayWeekStart), todayStr = formatDate(new Date());
            document.getElementById('weekly-title').textContent = `${start.getMonth()+1}.${start.getDate()} - ${new Date(start.getTime() + 518400000).getMonth()+1}.${new Date(start.getTime() + 518400000).getDate()}`;
            const cont = document.getElementById('weekly-container');
            cont.innerHTML = '';
            for(let i=0; i<7; i++){
                const cur = new Date(start); cur.setDate(cur.getDate()+i); 
                const dStr = formatDate(cur); const mDay = dStr.substring(5);
                const isHoliday = !!state.holidayPatch[dStr];
                const anni = state.settings.anniversaries?.find(a => a.date === mDay);
                const cls = isHoliday ? 'is-holiday' : (anni ? 'is-anniversary' : (cur.getDay()===0?'is-sunday':(cur.getDay()===6?'is-saturday':'')));
                const card = document.createElement('div');
                card.className = `bg-white/40 p-4 rounded border border-gray-100 transition-all ${dStr === todayStr ? 'is-today' : ''}`;
                const main = (state.allData[dStr] || {}).mainObjective || "";
                card.innerHTML = `<div class="flex justify-between items-start mb-2"><div class="cursor-pointer" onclick="window.goToDate('${dStr}')"><span class="text-xl font-black ${cls}">${cur.getDate()}</span><span class="text-[10px] font-black uppercase ${cls} ml-2">${dayNames[cur.getDay()]}</span>${isHoliday ? '<span class="jp-flag" style="transform:scale(0.8)"></span>' : ''}</div><span class="text-[8px] font-bold ${cls}">${anni ? anni.label : (state.holidayPatch[dStr] || "")}</span></div><input type="text" class="row-input w-full font-bold" value="${main}" placeholder="..." onchange="window.saveQuickPlan('${dStr}', this.value)">`;
                cont.appendChild(card);
            }
        }

        function renderMonthly() {
            const y = state.displayMonth.getFullYear(), m = state.displayMonth.getMonth(), todayStr = formatDate(new Date());
            document.getElementById('monthly-title').textContent = `${y} / ${m + 1}`;
            const cont = document.getElementById('monthly-list-container');
            cont.innerHTML = '';
            for (let d = 1; d <= new Date(y, m + 1, 0).getDate(); d++) {
                const cur = new Date(y, m, d), dStr = formatDate(cur); const mDay = dStr.substring(5);
                const isHoliday = !!state.holidayPatch[dStr];
                const anni = state.settings.anniversaries?.find(a => a.date === mDay);
                const cls = isHoliday ? 'is-holiday' : (anni ? 'is-anniversary' : (cur.getDay()===0?'is-sunday':(cur.getDay()===6?'is-saturday':'')));
                const row = document.createElement('div');
                row.className = `list-row ${cls} ${dStr === todayStr ? 'is-today' : ''}`;
                const main = (state.allData[dStr] || {}).mainObjective || "";
                row.innerHTML = `<div class="day-num cursor-pointer ${cls}" onclick="window.goToDate('${dStr}')">${d}</div><div class="day-name ${cls}">${dayNames[cur.getDay()]}</div><div class="day-almanac">${isHoliday ? '<span class="jp-flag" style="transform:scale(0.6)"></span>' : (anni ? 'üéÇ' : '')}</div><input type="text" class="row-input font-bold" value="${main}" placeholder="..." onchange="window.saveQuickPlan('${dStr}', this.value)">`;
                cont.appendChild(row);
            }
        }

        window.handleAuth = async () => {
            const e = document.getElementById('auth-email').value, p = document.getElementById('auth-password').value;
            try {
                if (state.authMode === 'login') await signInWithEmailAndPassword(authInstance, e, p);
                else await createUserWithEmailAndPassword(authInstance, e, p);
            } catch (e) { els.authError.textContent = "Ë™çË®º„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü"; }
        };
        window.handleGoogleAuth = async () => {
            const googleProvider = new GoogleAuthProvider();
            googleProvider.setCustomParameters({ prompt: 'select_account' });
            try { await signInWithPopup(authInstance, googleProvider); } catch (e) { els.authError.textContent = "GoogleË™çË®ºÂ§±Êïó"; }
        };
        window.toggleAuthMode = () => {
            state.authMode = state.authMode === 'login' ? 'signup' : 'login';
            document.getElementById('auth-submit-btn').textContent = state.authMode === 'login' ? 'LOGIN' : 'SIGN UP';
            document.getElementById('auth-switch-text').textContent = state.authMode === 'login' ? 'Êñ∞Ë¶èÁôªÈå≤„ÅØ„Åì„Å°„Çâ' : 'Êó¢„Å´„Ç¢„Ç´„Ç¶„É≥„Éà„Çí„ÅäÊåÅ„Å°„ÅÆÊñπ';
        };
        window.handleLogout = () => signOut(authInstance).then(() => { state.allData = {}; location.reload(); });

        window.goToDate = (s) => { state.currentDate = s; state.view = 'daily'; refreshUI(); };
        window.openDatePicker = () => els.datePicker.showPicker();
        window.autoResize = (t) => { t.style.height='auto'; t.style.height=t.scrollHeight+'px'; };

        window.handlePrev = () => {
            const d = parseLocalDate(state.currentDate);
            if(state.view==='daily') d.setDate(d.getDate()-1);
            else if(state.view==='weekly') d.setDate(d.getDate()-7);
            else d.setMonth(d.getMonth()-1);
            window.goToDate(formatDate(d));
        };
        window.handleNext = () => {
            const d = parseLocalDate(state.currentDate);
            if(state.view==='daily') d.setDate(d.getDate()+1);
            else if(state.view==='weekly') d.setDate(d.getDate()+7);
            else d.setMonth(d.getMonth()+1);
            window.goToDate(formatDate(d));
        };

        window.setTheme = (n) => { state.settings.theme = n; saveSettings(); };
        function applyTheme() {
            const t = themes[state.settings.theme] || themes.standard;
            Object.keys(t).forEach(k => document.documentElement.style.setProperty(k, t[k]));
            document.body.style.backgroundColor = t['--body-bg'];
            document.querySelectorAll('.theme-swatch').forEach(s => {
                const clickAttr = s.getAttribute('onclick');
                if (clickAttr) {
                    const match = clickAttr.match(/'([^']+)'/);
                    if (match && match[1] === state.settings.theme) s.classList.add('active');
                    else s.classList.remove('active');
                }
            });
            renderAnniversaries(); refreshUI();
        }
        async function saveSettings() {
            if (state.user) await setDoc(doc(db, 'artifacts', appId, 'users', state.user.uid, 'settings', 'config'), state.settings);
            applyTheme();
        }
        window.addAnniversary = () => {
            const l = document.getElementById('anni-label').value.trim(), d = document.getElementById('anni-date').value.trim();
            if(l && /^\d{2}-\d{2}$/.test(d)){
                if (!state.settings.anniversaries) state.settings.anniversaries = [];
                state.settings.anniversaries.push({id: Date.now(), label: l, date: d});
                document.getElementById('anni-label').value=''; document.getElementById('anni-date').value=''; saveSettings();
            }
        };
        window.removeAnniversary = (id) => { state.settings.anniversaries = state.settings.anniversaries.filter(a => a.id !== id); saveSettings(); };
        function renderAnniversaries() {
            if (!els.anniversaryList || !state.settings.anniversaries) return;
            els.anniversaryList.innerHTML = '';
            state.settings.anniversaries.forEach(a => {
                const div = document.createElement('div'); div.className = 'anniversary-item';
                div.innerHTML = `<span class="font-bold text-[10px] flex-grow text-main">${a.label} (${a.date})</span><button onclick="window.removeAnniversary(${a.id})" class="text-red-400 font-bold text-xs">‚úï</button>`;
                els.anniversaryList.appendChild(div);
            });
        }

        let st; window.debouncedSave = () => {
            clearTimeout(st);
            st = setTimeout(async () => {
                if(!state.user) return;
                const todos = []; document.querySelectorAll('#todo-list .todo-item').forEach(i => {
                    const t = i.querySelector('input[type="text"]'), c = i.querySelector('input[type="checkbox"]');
                    if(t && (t.value.trim() || c.checked)) todos.push({text: t.value, checked: c.checked});
                });
                await setDoc(doc(db, 'artifacts', appId, 'users', state.user.uid, 'dailyData', state.currentDate), { mainObjective: els.mainObj.value, note: els.note.value, todos, updatedAt: Date.now() }, { merge: true });
                els.syncStatus.textContent = "SYNCED";
            }, 1000);
        };
        window.saveQuickPlan = async (dStr, text) => {
            if(!state.user) return;
            await setDoc(doc(db, 'artifacts', appId, 'users', state.user.uid, 'dailyData', dStr), { mainObjective: text, updatedAt: Date.now() }, { merge: true });
        };

        function renderTodos(todos) {
            if (document.activeElement && document.activeElement.closest('.todo-item')) return;
            els.todo.innerHTML = '';
            if (todos.length === 0) window.addTodo(); else todos.forEach(t => window.addTodo(t.text, t.checked));
        }
        window.addTodo = (text = '', checked = false) => {
            const div = document.createElement('div'); div.className = 'todo-item flex items-center mb-3';
            div.innerHTML = `<input type="checkbox" ${checked ? 'checked' : ''} onchange="window.debouncedSave()"><input type="text" class="ml-4 bg-transparent border-b border-transparent focus:border-accent-gold outline-none flex-grow text-sm font-bold text-main" value="${text}" placeholder="..." oninput="window.debouncedSave()">`;
            els.todo.appendChild(div);
        };

        function formatDate(d) { return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`; }
        function parseLocalDate(s) { const p = s.split('-'); return new Date(p[0], p[1]-1, p[2]); }

        start();
    </script>
</body>
</html>