<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Premium Vertical Planner - Cloud Almanac</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=LINE+Seed+JP:wght@400;700;800&family=Shippori+Mincho:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/weather-icons/2.0.12/css/weather-icons.min.css">
    <style>
        :root {
            /* Standard Theme Default */
            --cover-color: #1a202c;
            --paper-bg: #fdfaf5;
            --line-color: #e2d9c8;
            --text-main: #2d3748;
            --accent-gold: #b69b5c;
            --accent-soft: #718096;
            --holiday-red: #a52a2a;
            --saturday-blue: #4a6791;
            --anniversary-color: #d69e2e;
        }

        body {
            font-family: 'LINE Seed JP', sans-serif;
            background-color: var(--body-bg, #2c3e50);
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            margin: 0;
            padding: env(safe-area-inset-top) 10px 20px 10px;
            color: var(--text-main);
            overflow-x: hidden;
            transition: all 0.5s ease;
        }

        .notebook-container {
            width: 100%;
            max-width: 520px;
            perspective: 1500px;
        }

        .notebook {
            background-color: var(--paper-bg);
            border-radius: 4px;
            box-shadow: 
                0 0 0 8px var(--cover-color),
                0 20px 50px rgba(0,0,0,0.5),
                inset 0 0 10px rgba(0,0,0,0.05);
            position: relative;
            min-height: 850px;
            display: flex;
            flex-direction: column;
            border: 1px solid rgba(0,0,0,0.1);
            overflow: hidden;
            transition: box-shadow 0.3s ease;
        }

        .jp-flag {
            display: inline-block;
            width: 18px;
            height: 12px;
            background-color: #ffffff;
            border: 0.5px solid #ddd;
            position: relative;
            vertical-align: middle;
            margin-left: 6px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
        .jp-flag::after {
            content: "";
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            width: 6px; height: 6px;
            background-color: #bc002d;
            border-radius: 50%;
        }

        .loader {
            width: 40px;
            height: 20px;
            --c: no-repeat radial-gradient(farthest-side, var(--accent-gold) 93%, #0000);
            background:
                var(--c) 0    0,
                var(--c) 50%  0,
                var(--c) 100% 0;
            background-size: 8px 8px;
            position: relative;
            animation: l4-0 1s linear infinite alternate;
        }
        .loader:before {
            content: "";
            position: absolute;
            width: 8px;
            height: 12px;
            background: var(--accent-gold);
            left: 0;
            top: 0;
            animation: 
                l4-1 1s  linear infinite alternate,
                l4-2 0.5s cubic-bezier(0,200,.8,200) infinite;
        }
        @keyframes l4-0 {
            0%      {background-position: 0   100%, 50% 0   , 100% 0}
            8%,42%  {background-position: 0   0   , 50% 0   , 100% 0}
            50%     {background-position: 0   0   , 50% 100%, 100% 0}
            58%,92% {background-position: 0   0   , 50% 0   , 100% 0}
            100%    {background-position: 0   0   , 50% 0   , 100% 100%}
        }
        @keyframes l4-1 { 100% {left:calc(100% - 8px)} }
        @keyframes l4-2 { 100% {top:-0.1px} }

        .page-content { padding: 25px 0 20px 0; flex-grow: 1; z-index: 2; position: relative; }
        .jp-header {
            font-family: 'Shippori Mincho', serif; border-bottom: 1.5px solid var(--accent-gold);
            margin: 0 35px 20px 35px; padding-bottom: 8px; font-size: 0.85rem; color: var(--accent-gold);
            display: flex; justify-content: space-between; align-items: baseline; letter-spacing: 0.1em; font-weight: 700;
        }

        .tab-btn {
            flex: 1; padding: 12px 0; font-size: 0.6rem; font-weight: 800; color: var(--accent-soft);
            border-bottom: 1px solid var(--line-color); transition: all 0.3s ease; letter-spacing: 0.1em; background: rgba(0,0,0,0.02);
        }
        .tab-active { color: var(--cover-color); background: transparent; border-bottom: 2.5px solid var(--cover-color); }

        .list-row { display: flex; align-items: center; border-bottom: 1px solid var(--line-color); padding: 12px 30px; transition: background 0.2s; position: relative; z-index: 5; }
        .day-num { width: 35px; font-weight: 800; font-size: 1.1rem; }
        .day-name { width: 40px; font-size: 0.7rem; font-weight: 800; }
        .day-almanac { width: 110px; font-size: 0.6rem; color: var(--accent-gold); font-weight: 700; line-height: 1.2; overflow: hidden; }

        .row-input { flex-grow: 1; background: transparent; border: none; outline: none; font-size: 0.9rem; color: var(--text-main); font-weight: 400; padding: 2px 0; }

        .diary-area {
            font-family: 'Shippori Mincho', serif; line-height: 2.2; background-size: 100% 2.2em;
            background-image: linear-gradient(var(--line-color) 0.5px, transparent 0.5px);
            background-attachment: local; padding-left: 5px; position: relative; z-index: 5; min-height: 200px;
        }

        .is-sunday, .is-holiday { color: var(--holiday-red) !important; }
        .is-saturday { color: var(--saturday-blue) !important; }
        .is-anniversary { color: var(--anniversary-color) !important; }
        .is-today { background-color: rgba(182, 155, 92, 0.08) !important; border-left: 4px solid var(--accent-gold) !important; position: relative; }
        
        .daily-date-display { font-family: 'Shippori Mincho', serif; cursor: pointer; letter-spacing: 0.05em; }

        .auth-card { background: var(--paper-bg); padding: 40px; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); width: 100%; max-width: 400px; }
        .auth-input { width: 100%; padding: 14px; margin-bottom: 12px; border: 1px solid var(--line-color); border-radius: 8px; font-size: 0.9rem; outline: none; background: #fff; }
        .auth-btn { width: 100%; padding: 14px; background: var(--cover-color); color: #fff; border-radius: 8px; font-weight: 800; letter-spacing: 0.1em; margin-top: 5px; }
        
        .google-btn {
            width: 100%; padding: 12px; background: #fff; color: #3c4043; border: 1px solid #dadce0;
            border-radius: 8px; font-weight: 600; display: flex; align-items: center;
            justify-content: center; gap: 12px; margin-top: 15px; font-size: 0.9rem;
            transition: background-color 0.2s, box-shadow 0.2s;
        }
        .google-btn:hover { background-color: #f8f9fa; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }

        .theme-swatch { width: 32px; height: 32px; border-radius: 50%; border: 2px solid #fff; cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.1); transition: 0.2s; position: relative; }
        .theme-swatch.active { transform: scale(1.2); box-shadow: 0 0 0 2px var(--accent-gold); }

        .header-obj-block { flex-grow: 1; margin-left: 1rem; position: relative; }
        .header-obj-input { width: 100%; background: rgba(0,0,0,0.03); border: none; border-left: 2px solid var(--accent-gold); color: var(--text-main); font-size: 0.9rem; font-weight: 700; padding: 6px 10px; outline: none; }
        .header-obj-label { position: absolute; top: -12px; left: 4px; font-size: 6px; font-weight: 900; color: var(--accent-gold); opacity: 0.7; }

        .hidden { display: none !important; }
        .flip-up { animation: flipUp 0.4s cubic-bezier(0.2, 0, 0.2, 1); }
        @keyframes flipUp { from { transform: translateY(10px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    </style>
</head>
<body>

    <!-- Loading Overlay -->
    <div id="loading" class="fixed inset-0 z-[1000] flex flex-col items-center justify-center bg-white">
        <div class="flex flex-col items-center gap-8">
            <div class="loader"></div>
            <div id="loading-text" class="text-accent-gold font-bold tracking-[0.4em] animate-pulse text-[10px]">INITIALIZING...</div>
        </div>
    </div>

    <div class="sync-status fixed top-2 right-2 text-[8px] opacity-30 z-[100]" id="sync-status">OFFLINE</div>

    <div class="notebook-container w-full max-w-[520px] mx-auto">
        
        <!-- Auth View -->
        <div id="view-auth" class="hidden h-screen flex items-center justify-center px-6">
            <div class="auth-card">
                <div class="text-center mb-8">
                    <h1 class="font-serif text-xl font-bold tracking-[0.3em] text-cover-color mb-1 uppercase">Cloud Planner</h1>
                    <div class="h-1 w-12 bg-accent-gold mx-auto"></div>
                </div>
                <input type="email" id="auth-email" class="auth-input" placeholder="Email Address">
                <input type="password" id="auth-password" class="auth-input" placeholder="Password">
                <button onclick="window.handleAuth()" id="auth-submit-btn" class="auth-btn uppercase">Login</button>
                
                <button onclick="window.handleGoogleAuth()" class="google-btn">
                    <svg width="18" height="18" viewBox="0 0 18 18"><path d="M17.64 9.2c0-.637-.057-1.251-.164-1.84H9v3.481h4.844c-.209 1.125-.843 2.078-1.796 2.717v2.258h2.908c1.702-1.567 2.684-3.874 2.684-6.615z" fill="#4285f4"/><path d="M9 18c2.43 0 4.467-.806 5.956-2.184L12.048 13.56c-.408.273-.93.432-1.548.432-1.191 0-2.199-.806-2.557-1.889H4.912v2.335A8.997 8.997 0 0 0 9 18z" fill="#34a853"/><path d="M6.443 12.103c-.188-.564-.296-1.166-.296-1.79 0-.624.108-1.226.296-1.79V6.188H4.912a8.992 8.992 0 0 0 0 8.251l1.531-2.336z" fill="#fbbc05"/><path d="M9 4.009c1.322 0 2.509.454 3.441 1.345l2.582-2.58C13.463 1.155 11.427 0 9 0A8.997 8.997 0 0 0 4.912 2.335L6.443 4.67c.358-1.083 1.366-1.889 2.557-1.889z" fill="#ea4335"/></svg>
                    Googleでサインイン
                </button>

                <p id="auth-error-msg" class="text-[10px] text-red-500 mt-4 text-center h-4"></p>
                <div onclick="window.toggleAuthMode()" id="auth-switch-text" class="text-[10px] text-accent-soft text-center mt-6 cursor-pointer underline">新規登録はこちら</div>
            </div>
        </div>

        <!-- Main UI -->
        <div id="app-main" class="notebook hidden">
            <div id="main-nav" class="flex bg-white/50 sticky top-0 z-20 border-b border-gray-100">
                <button onclick="switchView('monthly')" class="tab-btn" id="tab-monthly">MONTHLY</button>
                <button onclick="switchView('weekly')" class="tab-btn" id="tab-weekly">WEEKLY</button>
                <button onclick="switchView('daily')" class="tab-btn" id="tab-daily">DAILY</button>
                <button onclick="switchView('settings')" class="tab-btn" id="tab-settings">CONFIG</button>
            </div>

            <div class="page-content" id="page-body">
                <div class="jp-header" id="jp-header-text"></div>
                
                <!-- Daily -->
                <div id="view-daily" class="px-10">
                    <div class="flex justify-between items-end border-b border-gray-300 pb-3 mb-2">
                        <div class="flex items-baseline relative shrink-0">
                            <div id="date-label" class="daily-date-display font-bold text-4xl" onclick="window.openDatePicker()"></div>
                            <input type="date" id="date-picker-hidden" style="position:absolute; opacity:0; pointer-events:none;">
                        </div>
                        <div class="header-obj-block">
                            <span class="header-obj-label">MAIN OBJECTIVE</span>
                            <input type="text" id="main-objective-field" class="header-obj-input" placeholder="..." oninput="window.debouncedSave()">
                        </div>
                        <div id="daily-holiday-name" class="font-bold text-[9px] text-holiday-red mb-1 shrink-0 ml-1"></div>
                    </div>
                    <div id="daily-almanac" class="flex gap-4 font-serif text-[0.8rem] text-accent-gold font-bold mb-8"></div>
                    <div class="mb-10"><h3 class="text-[8px] font-black text-gray-400 uppercase tracking-[0.3em] mb-4">Missions</h3><div id="todo-list"></div><button onclick="window.addTodo()" class="btn-action mt-2">+ NEW TASK</button></div>
                    <div><h3 class="text-[8px] font-black text-gray-400 uppercase tracking-[0.3em] mb-4">Reflections</h3><textarea id="note-area" class="diary-area w-full text-lg bg-transparent border-none outline-none resize-none overflow-hidden" placeholder="..." oninput="window.autoResize(this); window.debouncedSave()"></textarea></div>
                </div>

                <!-- Weekly -->
                <div id="view-weekly" class="hidden px-8">
                    <div class="flex justify-between items-center mb-6"><button onclick="changeWeek(-1)" class="p-2">◀</button><h2 id="weekly-title" class="text-xs font-bold tracking-widest text-accent-soft"></h2><button onclick="changeWeek(1)" class="p-2">▶</button></div>
                    <div id="weekly-container" class="space-y-4"></div>
                </div>

                <!-- Monthly -->
                <div id="view-monthly" class="hidden">
                    <div class="px-10 mb-6 flex justify-between items-center"><button onclick="changeMonth(-1)" class="text-accent-soft">◀</button><h2 id="monthly-title" class="text-lg font-black border-b-2 border-accent-gold pb-1 px-4"></h2><button onclick="changeMonth(1)" class="text-accent-soft">▶</button></div>
                    <div id="monthly-list-container"></div>
                </div>

                <!-- Config -->
                <div id="view-settings" class="hidden px-10 pt-5">
                    <div class="mb-10"><h3 class="text-[9px] font-black text-gray-400 uppercase tracking-[0.3em] mb-6 text-center">THEMES</h3><div class="grid grid-cols-5 gap-y-6 gap-x-2" id="theme-selector">
                        <div class="theme-swatch active" onclick="setTheme('standard')" style="background: #1a202c;"></div><div class="theme-swatch" onclick="setTheme('midnight')" style="background: #1a2639;"></div><div class="theme-swatch" onclick="setTheme('forest')" style="background: #2d4a22;"></div><div class="theme-swatch" onclick="setTheme('sakura')" style="background: #fec5bb;"></div><div class="theme-swatch" onclick="setTheme('akane')" style="background: #7a1a1a;"></div><div class="theme-swatch" onclick="setTheme('sumizome')" style="background: #000000;"></div><div class="theme-swatch" onclick="setTheme('asagi')" style="background: #008b8b;"></div><div class="theme-swatch" onclick="setTheme('yamabuki')" style="background: #d97706;"></div><div class="theme-swatch" onclick="setTheme('kachiiro')" style="background: #0d1b2a;"></div><div class="theme-swatch" onclick="setTheme('uguisu')" style="background: #606c38;"></div>
                    </div></div>
                    <div class="mt-20 border-t border-gray-200 pt-6 text-center"><button onclick="window.handleLogout()" class="text-xs font-bold text-red-400 tracking-widest uppercase mb-4">Logout</button></div>
                </div>
            </div>

            <div class="p-5 bg-black/5 border-t border-gray-100 flex justify-between items-center text-[8px] text-gray-400 tracking-[0.4em] font-black">
                <button onclick="window.handlePrev()">PREV</button>
                <span>SYNC ACTIVE</span>
                <button onclick="window.handleNext()">NEXT</button>
            </div>
        </div>
    </div>

    <!-- Firebase & Planner Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, onSnapshot, collection } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // ================================================================
        // Firebase
        // ================================================================
        const firebaseConfig = {
  apiKey: "AIzaSyB-CKqjGBrl3239d2K0X4C9ceFA0tUhoDs",
  authDomain: "pro-planner-a9405.firebaseapp.com",
  projectId: "pro-planner-a9405",
  storageBucket: "pro-planner-a9405.firebasestorage.app",
  messagingSenderId: "930319488179",
  appId: "1:930319488179:web:dbc0f9f2530fd6fe828cc6",
  measurementId: "G-LTRFWPFH63"
};
        };
        // ================================================================

        // 要素取得
        const els = {
            loading: document.getElementById('loading'),
            loadText: document.getElementById('loading-text'),
            auth: document.getElementById('view-auth'),
            app: document.getElementById('app-main'),
            syncStatus: document.getElementById('sync-status'),
            dateLabel: document.getElementById('date-label'),
            datePicker: document.getElementById('date-picker-hidden'),
            jpHeader: document.getElementById('jp-header-text'),
            mainObj: document.getElementById('main-objective-field'),
            note: document.getElementById('note-area'),
            todo: document.getElementById('todo-list'),
            authEmail: document.getElementById('auth-email'),
            authPass: document.getElementById('auth-password'),
            authSwitch: document.getElementById('auth-switch-text'),
            authBtn: document.getElementById('auth-submit-btn'),
            authError: document.getElementById('auth-error-msg')
        };

        const themes = {
            standard: { '--cover-color': '#1a202c', '--accent-gold': '#b69b5c', '--accent-soft': '#718096', '--paper-bg': '#fdfaf5', '--text-main': '#2d3748', '--body-bg': '#2c3e50', '--anniversary-color': '#d69e2e' },
            midnight: { '--cover-color': '#1a2639', '--accent-gold': '#8da9c4', '--accent-soft': '#667b94', '--paper-bg': '#f0f4f8', '--text-main': '#1a2639', '--body-bg': '#0b132b', '--anniversary-color': '#718096' },
            forest: { '--cover-color': '#2d4a22', '--accent-gold': '#a3b18a', '--accent-soft': '#588157', '--paper-bg': '#f0f5ec', '--text-main': '#1b261b', '--body-bg': '#132a13', '--anniversary-color': '#b69b5c' },
            sakura: { '--cover-color': '#f8ad9d', '--accent-gold': '#ffb5a7', '--accent-soft': '#fbc4ab', '--paper-bg': '#fff5f5', '--text-main': '#6d4c41', '--body-bg': '#fec5bb', '--anniversary-color': '#e07a5f' },
            akane: { '--cover-color': '#7a1a1a', '--accent-gold': '#f6ad55', '--accent-soft': '#dd6b20', '--paper-bg': '#fff5f5', '--text-main': '#2d3748', '--body-bg': '#4a1111', '--anniversary-color': '#e53e3e' },
            sumizome: { '--cover-color': '#000000', '--accent-gold': '#718096', '--accent-soft': '#a0aec0', '--paper-bg': '#ffffff', '--text-main': '#000000', '--body-bg': '#1a202c', '--anniversary-color': '#4a5568' },
            asagi: { '--cover-color': '#008b8b', '--accent-gold': '#48cae4', '--accent-soft': '#0096c7', '--paper-bg': '#f8ffff', '--text-main': '#1a202c', '--body-bg': '#005f73', '--anniversary-color': '#0077b6' },
            yamabuki: { '--cover-color': '#d97706', '--accent-gold': '#fbbf24', '--accent-soft': '#b45309', '--paper-bg': '#fffbeb', '--text-main': '#000000', '--body-bg': '#92400e', '--anniversary-color': '#f59e0b' },
            kachiiro: { '--cover-color': '#0d1b2a', '--accent-gold': '#e0e1dd', '--accent-soft': '#778da9', '--paper-bg': '#f4f4f9', '--text-main': '#0d1b2a', '--body-bg': '#1b263b', '--anniversary-color': '#415a77' },
            uguisu: { '--cover-color': '#606c38', '--accent-gold': '#dda15e', '--accent-soft': '#bc6c25', '--paper-bg': '#fefae0', '--text-main': '#283618', '--body-bg': '#283618', '--anniversary-color': '#bc6c25' }
        };

        const state = {
            user: null,
            view: 'daily',
            authMode: 'login',
            currentDate: new Date().toISOString().split('T')[0],
            allData: {},
            holidayPatch: {},
            settings: { theme: 'standard' }
        };

        const appId = "my-planner-v1";
        let db, authInstance;

        // 初期化
        async function start() {
            try {
                console.log("App Starting...");
                const app = initializeApp(firebaseConfig);
                authInstance = getAuth(app);
                db = getFirestore(app);

                // 祝日データ取得 (失敗しても続行)
                try {
                    const res = await fetch('https://holidays-jp.github.io/api/v1/date.json');
                    if (res.ok) state.holidayPatch = await res.json();
                } catch(e) { console.warn("Holiday API error"); }

                // 認証状態の監視
                onAuthStateChanged(authInstance, async (user) => {
                    if (user) {
                        state.user = user;
                        els.auth.classList.add('hidden');
                        els.app.classList.remove('hidden');
                        
                        // 設定読み込み
                        const snap = await getDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'settings', 'config'));
                        if (snap.exists()) state.settings = snap.data();
                        
                        applyTheme();
                        els.loading.classList.add('hidden');
                        
                        // データ同期開始
                        onSnapshot(collection(db, 'artifacts', appId, 'users', user.uid, 'dailyData'), (snap) => {
                            snap.forEach(d => { state.allData[d.id] = d.data(); });
                            refreshUI();
                        });
                    } else {
                        els.loading.classList.add('hidden');
                        els.auth.classList.remove('hidden');
                        els.app.classList.add('hidden');
                    }
                });

            } catch (err) {
                console.error("Critical Start Error:", err);
                els.loadText.textContent = "CONFIG ERROR: Check Console";
            }
        }

        // --- UI functions ---
        window.switchView = (v) => { state.view = v; refreshUI(); };
        window.goToDate = (s) => { state.currentDate = s; state.view = 'daily'; refreshUI(); };
        window.openDatePicker = () => els.datePicker.showPicker();
        window.setTheme = (n) => { state.settings.theme = n; saveSettings(); };
        window.handleLogout = () => signOut(authInstance).then(() => location.reload());
        
        window.toggleAuthMode = () => {
            state.authMode = state.authMode === 'login' ? 'signup' : 'login';
            els.authBtn.textContent = state.authMode === 'login' ? 'LOGIN' : 'SIGN UP';
            els.authSwitch.textContent = state.authMode === 'login' ? '新規登録はこちら' : 'ログインはこちら';
        };

        window.handleAuth = async () => {
            try {
                if (state.authMode === 'login') await signInWithEmailAndPassword(authInstance, els.authEmail.value, els.authPass.value);
                else await createUserWithEmailAndPassword(authInstance, els.authEmail.value, els.authPass.value);
            } catch (e) { els.authError.textContent = "Auth failed: " + e.message; }
        };

        window.handleGoogleAuth = async () => {
            try { await signInWithPopup(authInstance, new GoogleAuthProvider()); } 
            catch (e) { els.authError.textContent = "Google Sign-in failed"; }
        };

        function applyTheme() {
            const t = themes[state.settings.theme] || themes.standard;
            Object.keys(t).forEach(k => document.documentElement.style.setProperty(k, t[k]));
            document.body.style.backgroundColor = t['--body-bg'];
            document.querySelectorAll('.theme-swatch').forEach(s => {
                const name = s.getAttribute('onclick').match(/'([^']+)'/)[1];
                s.classList.toggle('active', name === state.settings.theme);
            });
            refreshUI();
        }

        async function saveSettings() {
            if (state.user) await setDoc(doc(db, 'artifacts', appId, 'users', state.user.uid, 'settings', 'config'), state.settings);
            applyTheme();
        }

        function refreshUI() {
            const d = new Date(state.currentDate);
            const fs = state.currentDate, md = fs.substring(5);
            const holidayName = state.holidayPatch[fs] || "";
            const isHoliday = !!holidayName;
            
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.toggle('tab-active', b.id === `tab-${state.view}`));
            Object.keys(state.views).forEach(k => state.views[k].classList.toggle('hidden', k !== state.view));

            els.jpHeader.innerHTML = `<span>${d.getMonth()+1}月</span><span>${d.getFullYear()}年</span>`;
            
            if (state.view === 'daily') {
                els.dateLabel.innerHTML = `${d.getDate()}日 ${isHoliday ? '<span class="jp-flag"></span>' : ''}`;
                els.dailyHolidayName.textContent = holidayName;
                const data = state.allData[state.currentDate] || { mainObjective: "", note: "", todos: [] };
                if (document.activeElement !== els.mainObj) els.mainObj.value = data.mainObjective || "";
                if (document.activeElement !== els.note) els.note.value = data.note || "";
                renderTodos(data.todos || []);
            }
        }

        function renderTodos(todos) {
            if (document.activeElement && document.activeElement.closest('.todo-item')) return;
            els.todo.innerHTML = '';
            if (todos.length === 0) window.addTodo(); else todos.forEach(t => window.addTodo(t.text, t.checked));
        }

        window.addTodo = (text = '', checked = false) => {
            const div = document.createElement('div'); div.className = 'todo-item flex items-center mb-3';
            div.innerHTML = `<input type="checkbox" ${checked ? 'checked' : ''} onchange="window.debouncedSave()"><input type="text" class="ml-4 bg-transparent border-b border-transparent focus:border-accent-gold outline-none flex-grow text-sm" value="${text}" oninput="window.debouncedSave()">`;
            els.todo.appendChild(div);
        };

        let st; window.debouncedSave = () => {
            clearTimeout(st);
            st = setTimeout(async () => {
                if(!state.user) return;
                const todos = []; document.querySelectorAll('#todo-list .todo-item').forEach(i => {
                    const t = i.querySelector('input[type="text"]'), c = i.querySelector('input[type="checkbox"]');
                    if(t.value.trim() || c.checked) todos.push({text: t.value, checked: c.checked});
                });
                await setDoc(doc(db, 'artifacts', appId, 'users', state.user.uid, 'dailyData', state.currentDate), { mainObjective: els.mainObj.value, note: els.note.value, todos, updatedAt: Date.now() }, { merge: true });
                els.syncStatus.textContent = "SYNCED";
            }, 1000);
        };

        window.autoResize = (t) => { t.style.height='auto'; t.style.height=t.scrollHeight+'px'; };

        start();
    </script>
</body>
</html>